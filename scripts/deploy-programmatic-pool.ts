import { createWalletClient, createPublicClient, http, parseEther, formatUnits } from 'viem';
import { privateKeyToAccount } from 'viem/accounts';
import { defineChain } from 'viem';
import { config } from 'dotenv';

config();

const arcTestnet = defineChain({
  id: 5042002,
  name: 'Arc Testnet',
  network: 'arc-testnet',
  nativeCurrency: {
    decimals: 6,
    name: 'USDC',
    symbol: 'USDC',
  },
  rpcUrls: {
    default: {
      http: [
        'https://rpc.testnet.arc.network',
        'https://rpc.blockdaemon.testnet.arc.network',
        'https://rpc.drpc.testnet.arc.network',
        'https://rpc.quicknode.testnet.arc.network'
      ],
    },
    public: {
      http: [
        'https://rpc.testnet.arc.network',
        'https://rpc.blockdaemon.testnet.arc.network',
        'https://rpc.drpc.testnet.arc.network',
        'https://rpc.quicknode.testnet.arc.network'
      ],
    },
  },
  blockExplorers: {
    default: { name: 'Arc Explorer', url: 'https://testnet.arcscan.app' },
  },
});

const AIC_PROGRAMMATIC_POOL_BYTECODE = '0x6080604052620f424060065534801562000017575f80fd5b50604051620020303803806200203083398181016040528101906200003d919062000467565b335f73ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff1603620000b1575f6040517f1e4fbdf7000000000000000000000000000000000000000000000000000000008152600401620000a89190620004e7565b60405180910390fd5b620000c2816200034160201b60201c565b50600180819055505f73ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff16036200013b576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401620001329062000560565b60405180910390fd5b5f73ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff1603620001ac576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401620001a390620005ce565b60405180910390fd5b5f73ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff16036200021d576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040162000214906200063c565b60405180910390fd5b8360025f6101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055508260035f6101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055508160075f6101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055508060085f6101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506509184e72a0006004819055506509184e72a000600581905550505050506200065c565b5f805f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff169050815f806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055508173ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e060405160405180910390a35050565b5f80fd5b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f620004318262000406565b9050919050565b620004438162000425565b81146200044e575f80fd5b50565b5f81519050620004618162000438565b92915050565b5f805f806080858703121562000482576200048162000402565b5b5f620004918782880162000451565b9450506020620004a48782880162000451565b9350506040620004b78782880162000451565b9250506060620004ca8782880162000451565b91505092959194509250565b620004e18162000425565b82525050565b5f602082019050620004fc5f830184620004d6565b92915050565b5f82825260208201905092915050565b7f496e76616c6964204149432061646472657373000000000000000000000000005f82015250565b5f6200054860138362000502565b9150620005558262000512565b602082019050919050565b5f6020820190508181035f83015262000579816200053a565b9050919050565b7f496e76616c6964205553444320616464726573730000000000000000000000005f82015250565b5f620005b660148362000502565b9150620005c38262000580565b602082019050919050565b5f6020820190508181035f830152620005e781620005a8565b9050919050565b7f496e76616c6964207472656173757279206164647265737300000000000000005f82015250565b5f6200062460188362000502565b91506200063182620005ee565b602082019050919050565b5f6020820190508181035f830152620006558162000616565b9050919050565b6119c6806200066a5f395ff3fe608060405234801561000f575f80fd5b506004361061014b575f3560e01c80637f51bb1f116100c15780639e522cb31161007a5780639e522cb31461037d578063a7ce3c511461039b578063abe685cd146103b7578063d0b47003146103d5578063d4fce842146103f1578063f2fde38b1461040f5761014b565b80637f51bb1f146102a95780638b1b5a44146102c55780638c73eb04146102f55780638da5cb5b1461031357806395ccea67146103315780639aafe1f91461034d5761014b565b80633dfdce66116101135780633dfdce66146101f75780634626402b1461022757806353861f141461024557806358a94746146102635780636a5809cc14610281578063715018a61461029f5761014b565b806303aa6b421461014f578063113b4a3a1461016d57806311eac8551461018b578063182029d2146101a95780632104b0d6146101d9575b5f80fd5b61015761042b565b6040516101649190611285565b60405180910390f35b610175610431565b6040516101829190611318565b60405180910390f35b610193610456565b6040516101a09190611318565b60405180910390f35b6101c360048036038101906101be919061135f565b61047b565b6040516101d09190611285565b60405180910390f35b6101e16104fb565b6040516101ee9190611285565b60405180910390f35b610211600480360381019061020c919061135f565b610504565b60405161021e9190611285565b60405180910390f35b61022f610584565b60405161023c91906113aa565b60405180910390f35b61024d6105a9565b60405161025a9190611285565b60405180910390f35b61026b6105ae565b6040516102789190611285565b60405180910390f35b6102896105e4565b6040516102969190611285565b60405180910390f35b6102a76105ed565b005b6102c360048036038101906102be91906113ed565b610600565b005b6102df60048036038101906102da9190611418565b610739565b6040516102ec9190611285565b60405180910390f35b6102fd610ac5565b60405161030a91906113aa565b60405180910390f35b61031b610aea565b60405161032891906113aa565b60405180910390f35b61034b60048036038101906103469190611456565b610b11565b005b61036760048036038101906103629190611418565b610bde565b6040516103749190611285565b60405180910390f35b610385610f47565b6040516103929190611285565b60405180910390f35b6103b560048036038101906103b09190611418565b610f4d565b005b6103bf610fed565b6040516103cc9190611285565b60405180910390f35b6103ef60048036038101906103ea919061135f565b610ff3565b005b6103f9611045565b6040516104069190611285565b60405180910390f35b610429600480360381019061042491906113ed565b61104b565b005b60065481565b60025f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60035f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b5f8082148061048b57505f600554145b15610498575f90506104f6565b5f601e6127106104a891906114c1565b836104b391906114f4565b90505f600454826104c491906114f4565b90505f826127106005546104d891906114f4565b6104e29190611535565b905080826104f09190611595565b93505050505b919050565b5f600454905090565b5f8082148061051457505f600454145b15610521575f905061057f565b5f601e61271061053191906114c1565b8361053c91906114f4565b90505f6005548261054d91906114f4565b90505f8261271060045461056191906114f4565b61056b9190611535565b905080826105799190611595565b93505050505b919050565b60075f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b601e81565b5f80600454036105c0575f90506105e1565b600454620f42406005546105d491906114f4565b6105de9190611595565b90505b90565b5f600554905090565b6105f56110cf565b6105fe5f611156565b565b6106086110cf565b5f73ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff1603610676576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161066d9061161f565b60405180910390fd5b5f60075f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1690508160075f6101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055508173ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff167f4ab5be82436d353e61ca18726e984e561f5c1cc7c6d38b29d2553c790434705a60405160405180910390a35050565b5f610742611217565b5f8311610784576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161077b90611687565b60405180910390fd5b5f601e61271061079491906114c1565b8461079f91906114f4565b90505f600554826107b091906114f4565b90505f826127106004546107c491906114f4565b6107ce9190611535565b905080826107dc9190611595565b935084841015610821576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610818906116ef565b60405180910390fd5b60025f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166323b872dd3330896040518463ffffffff1660e01b815260040161087f9392919061170d565b6020604051808303815f875af115801561089b573d5f803e3d5ffd5b505050506040513d601f19601f820116820180604052508101906108bf9190611777565b6108fe576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016108f5906117ec565b60405180910390fd5b60035f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166323b872dd60075f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1633876040518463ffffffff1660e01b815260040161097d9392919061170d565b6020604051808303815f875af1158015610999573d5f803e3d5ffd5b505050506040513d601f19601f820116820180604052508101906109bd9190611777565b6109fc576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016109f390611854565b60405180910390fd5b8560045f828254610a0d9190611535565b925050819055508360055f828254610a2591906114c1565b9250508190555060025f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff167ffa2dda1cc1b86e41239702756b13effbc1a092b5c57e3ad320fbe4f3b13fe2358887604051610aac929190611872565b60405180910390a3505050610abf61125d565b92915050565b60085f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b5f805f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905090565b610b196110cf565b8173ffffffffffffffffffffffffffffffffffffffff1663a9059cbb610b3d610aea565b836040518363ffffffff1660e01b8152600401610b5b929190611899565b6020604051808303815f875af1158015610b77573d5f803e3d5ffd5b505050506040513d601f19601f82011682018060405250810190610b9b9190611777565b610bda576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610bd19061190a565b60405180910390fd5b5050565b5f610be7611217565b5f8311610c29576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610c2090611687565b60405180910390fd5b5f601e612710610c3991906114c1565b84610c4491906114f4565b90505f60045482610c5591906114f4565b90505f82612710600554610c6991906114f4565b610c739190611535565b90508082610c819190611595565b935084841015610cc6576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610cbd906116ef565b60405180910390fd5b60035f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166323b872dd3330896040518463ffffffff1660e01b8152600401610d249392919061170d565b6020604051808303815f875af1158015610d40573d5f803e3d5ffd5b505050506040513d601f19601f82011682018060405250810190610d649190611777565b610da3576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610d9a90611854565b60405180910390fd5b60025f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1663a9059cbb33866040518363ffffffff1660e01b8152600401610dff929190611899565b6020604051808303815f875af1158015610e1b573d5f803e3d5ffd5b505050506040513d601f19601f82011682018060405250810190610e3f9190611777565b610e7e576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610e75906117ec565b60405180910390fd5b8560055f828254610e8f9190611535565b925050819055508360045f828254610ea791906114c1565b9250508190555060035f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff167ffa2dda1cc1b86e41239702756b13effbc1a092b5c57e3ad320fbe4f3b13fe2358887604051610f2e929190611872565b60405180910390a3505050610f4161125d565b92915050565b60055481565b610f556110cf565b5f82118015610f6357505f81115b610fa2576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610f9990611972565b60405180910390fd5b81600481905550806005819055507f645aa9c724799dce7df512bb35a464fa2f9dbaca82fe22e62b3eeec7f7142f2f8282604051610fe1929190611872565b60405180910390a15050565b61271081565b610ffb6110cf565b5f6006549050816006819055507f5a8ab44881dd6e6e6a886459cdcd541da1fdebb64c89e92664d0c1a2717d6b828183604051611039929190611872565b60405180910390a15050565b60045481565b6110536110cf565b5f73ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff16036110c3575f6040517f1e4fbdf70000000000000000000000000000000000000000000000000000000081526004016110ba91906113aa565b60405180910390fd5b6110cc81611156565b50565b6110d7611266565b73ffffffffffffffffffffffffffffffffffffffff166110f5610aea565b73ffffffffffffffffffffffffffffffffffffffff161461115457611118611266565b6040517f118cdaa700000000000000000000000000000000000000000000000000000000815260040161114b91906113aa565b60405180910390fd5b565b5f805f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff169050815f806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055508173ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e060405160405180910390a35050565b600260015403611253576040517f3ee5aeb500000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b6002600181905550565b60018081905550565b5f33905090565b5f819050919050565b61127f8161126d565b82525050565b5f6020820190506112985f830184611276565b92915050565b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f819050919050565b5f6112e06112db6112d68461129e565b6112bd565b61129e565b9050919050565b5f6112f1826112c6565b9050919050565b5f611302826112e7565b9050919050565b611312816112f8565b82525050565b5f60208201905061132b5f830184611309565b92915050565b5f80fd5b61133e8161126d565b8114611348575f80fd5b50565b5f8135905061135981611335565b92915050565b5f6020828403121561137457611373611331565b5b5f6113818482850161134b565b91505092915050565b5f6113948261129e565b9050919050565b6113a48161138a565b82525050565b5f6020820190506113bd5f83018461139b565b92915050565b6113cc8161138a565b81146113d6575f80fd5b50565b5f813590506113e7816113c3565b92915050565b5f6020828403121561140257611401611331565b5b5f61140f848285016113d9565b91505092915050565b5f806040838503121561142e5761142d611331565b5b5f61143b8582860161134b565b925050602061144c8582860161134b565b9150509250929050565b5f806040838503121561146c5761146b611331565b5b5f611479858286016113d9565b925050602061148a8582860161134b565b9150509250929050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601160045260245ffd5b5f6114cb8261126d565b91506114d68361126d565b92508282039050818111156114ee576114ed611494565b5b92915050565b5f6114fe8261126d565b91506115098361126d565b92508282026115178161126d565b9150828204841483151761152e5761152d611494565b5b5092915050565b5f61153f8261126d565b915061154a8361126d565b925082820190508082111561156257611561611494565b5b92915050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601260045260245ffd5b5f61159f8261126d565b91506115aa8361126d565b9250826115ba576115b9611568565b5b828204905092915050565b5f82825260208201905092915050565b7f496e76616c6964207472656173757279000000000000000000000000000000005f82015250565b5f6116096010836115c5565b9150611614826115d5565b602082019050919050565b5f6020820190508181035f830152611636816115fd565b9050919050565b7f496e76616c696420616d6f756e740000000000000000000000000000000000005f82015250565b5f611671600e836115c5565b915061167c8261163d565b602082019050919050565b5f6020820190508181035f83015261169e81611665565b9050919050565b7f536c6970706167652065786365656465640000000000000000000000000000005f82015250565b5f6116d96011836115c5565b91506116e4826116a5565b602082019050919050565b5f6020820190508181035f830152611706816116cd565b9050919050565b5f6060820190506117205f83018661139b565b61172d602083018561139b565b61173a6040830184611276565b949350505050565b5f8115159050919050565b61175681611742565b8114611760575f80fd5b50565b5f815190506117718161174d565b92915050565b5f6020828403121561178c5761178b611331565b5b5f61179984828501611763565b91505092915050565b7f414943207472616e73666572206661696c6564000000000000000000000000005f82015250565b5f6117d66013836115c5565b91506117e1826117a2565b602082019050919050565b5f6020820190508181035f830152611803816117ca565b9050919050565b7f55534443207472616e73666572206661696c65640000000000000000000000005f82015250565b5f61183e6014836115c5565b91506118498261180a565b602082019050919050565b5f6020820190508181035f83015261186b81611832565b9050919050565b5f6040820190506118855f830185611276565b6118926020830184611276565b9392505050565b5f6040820190506118ac5f83018561139b565b6118b96020830184611276565b9392505050565b7f5769746864726177206661696c656400000000000000000000000000000000005f82015250565b5f6118f4600f836115c5565b91506118ff826118c0565b602082019050919050565b5f6020820190508181035f830152611921816118e8565b9050919050565b7f5265736572766573206d75737420626520706f736974697665000000000000005f82015250565b5f61195c6019836115c5565b915061196782611928565b602082019050919050565b5f6020820190508181035f83015261198981611950565b905091905056fea264697066735822122067a904cd2da02487650cbba0f2cc15367787a9db86e2798bb69b0f9d4f871d5564736f6c63430008140033';

const AIC_PROGRAMMATIC_POOL_ABI = [
  {
    "inputs": [
      {"internalType": "address", "name": "_aicToken", "type": "address"},
      {"internalType": "address", "name": "_usdcToken", "type": "address"},
      {"internalType": "address", "name": "_treasuryWallet", "type": "address"},
      {"internalType": "address", "name": "_cctpMessageTransmitter", "type": "address"}
    ],
    "stateMutability": "nonpayable",
    "type": "constructor"
  },
  {
    "inputs": [{"internalType": "uint256", "name": "aicAmountIn", "type": "uint256"}, {"internalType": "uint256", "name": "minUsdcOut", "type": "uint256"}],
    "name": "swapAICForUSDC",
    "outputs": [{"internalType": "uint256", "name": "usdcOut", "type": "uint256"}],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [{"internalType": "uint256", "name": "usdcAmountIn", "type": "uint256"}, {"internalType": "uint256", "name": "minAicOut", "type": "uint256"}],
    "name": "swapUSDCForAIC",
    "outputs": [{"internalType": "uint256", "name": "aicOut", "type": "uint256"}],
    "stateMutability": "nonpayable",
    "type": "function"
  }
] as const;

async function main() {
  console.log('üöÄ Deploying AIC Programmatic Pool to Arc Testnet...\n');

  const privateKey = process.env.DEPLOYER_PRIVATE_KEY;
  if (!privateKey) {
    throw new Error('DEPLOYER_PRIVATE_KEY not found in .env');
  }

  const account = privateKeyToAccount(privateKey as any);

  const publicClient = createPublicClient({
    chain: arcTestnet,
    transport: http(),
  });

  const walletClient = createWalletClient({
    account,
    chain: arcTestnet,
    transport: http(),
  });

  console.log('üìç Deployer Address:', account.address);

  const balance = await publicClient.getBalance({ address: account.address });
  console.log('üí∞ Balance:', formatUnits(balance, 6), 'USDC\n');

  if (balance < 10000n) {
    throw new Error('‚ùå Insufficient balance. Need at least 0.01 USDC for gas');
  }

  const AIC_TOKEN = '0x4B71cD610AfCCDf0B02d566dA0071C74444a8666';
  const USDC_TOKEN = '0x3600000000000000000000000000000000000000';
  const TREASURY_WALLET = '0x43909cce967be2ba4d44836a99b67040bf53f05a';
  const CCTP_TRANSMITTER = '0x0000000000000000000000000000000000000000';

  console.log('üìã Deployment Parameters:');
  console.log('   AIC Token:', AIC_TOKEN);
  console.log('   USDC Token:', USDC_TOKEN);
  console.log('   Treasury:', TREASURY_WALLET);
  console.log('   CCTP:', CCTP_TRANSMITTER);
  console.log('');

  const encodedConstructor = encodeFunctionData({
    abi: [{
      "inputs": [
        {"internalType": "address", "name": "_aicToken", "type": "address"},
        {"internalType": "address", "name": "_usdcToken", "type": "address"},
        {"internalType": "address", "name": "_treasuryWallet", "type": "address"},
        {"internalType": "address", "name": "_cctpMessageTransmitter", "type": "address"}
      ],
      "stateMutability": "nonpayable",
      "type": "constructor"
    }],
    functionName: 'constructor' as any,
    args: [AIC_TOKEN, USDC_TOKEN, TREASURY_WALLET, CCTP_TRANSMITTER]
  });

  console.log('üî® Deploying contract with 0.01 USDC gas...');

  const hash = await walletClient.deployContract({
    abi: AIC_PROGRAMMATIC_POOL_ABI,
    bytecode: AIC_PROGRAMMATIC_POOL_BYTECODE as any,
    args: [AIC_TOKEN, USDC_TOKEN, TREASURY_WALLET, CCTP_TRANSMITTER],
    gas: 5000000n,
  });

  console.log('üì§ Transaction Hash:', hash);
  console.log('‚è≥ Waiting for confirmation...\n');

  const receipt = await publicClient.waitForTransactionReceipt({ hash });

  if (receipt.status === 'success' && receipt.contractAddress) {
    console.log('‚úÖ Contract deployed successfully!\n');
    console.log('üìç Contract Address:', receipt.contractAddress);
    console.log('‚õΩ Gas Used:', receipt.gasUsed.toString());
    console.log('üîó Explorer: https://testnet.arcscan.app/address/' + receipt.contractAddress);
    console.log('\nüìù Add this to your .env file:');
    console.log('VITE_AIC_PROGRAMMATIC_POOL_ADDRESS=' + receipt.contractAddress);
  } else {
    console.log('‚ùå Deployment failed');
  }
}

function encodeFunctionData(params: any): any {
  return '0x';
}

main().catch(console.error);
