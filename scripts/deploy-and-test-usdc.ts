import { createWalletClient, createPublicClient, http, parseUnits, formatUnits } from 'viem';
import { privateKeyToAccount } from 'viem/accounts';
import { defineChain } from 'viem';
import * as dotenv from 'dotenv';

dotenv.config();

const arcTestnet = defineChain({
  id: 1612227,
  name: 'Arc Testnet',
  network: 'arc-testnet',
  nativeCurrency: {
    decimals: 18,
    name: 'ARC',
    symbol: 'ARC',
  },
  rpcUrls: {
    default: { http: ['https://rpc.testnet.arc.network'] },
    public: { http: ['https://rpc.testnet.arc.network'] },
  },
  blockExplorers: {
    default: { name: 'Arc Explorer', url: 'https://testnet.arcscan.net' },
  },
});

const MOCKUSDC_BYTECODE = '0x608060405234801561001057600080fd5b5061001d3362000023565b62000086565b60006100348260066200004560201b60201c565b50600081600260008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000828254620000889190620000eb565b925050819055508173ffffffffffffffffffffffffffffffffffffffff16600073ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef83604051620000ef919062000167565b60405180910390a35050565b6000620001028284620001bd565b905092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b6000819050919050565b62000150816200013a565b82525050565b6200016181620001a8565b82525050565b60006020820190506200017e600083018462000145565b92915050565b60006200019182620001b2565b91506200019e83620001b2565b9250828201905092915050565b6000819050919050565b6000819050919050565b610a3a80620001c16000396000f3fe608060405234801561001057600080fd5b50600436106100ea5760003560e01c806342966c681161008c57806395d89b411161006657806395d89b4114610243578063a0712d6814610261578063a9059cbb1461027d578063dd62ed3e146102ad576100ea565b806342966c68146101d557806370a08231146101f157806379cc679014610221576100ea565b806323b872dd116100c857806323b872dd1461014d578063313ce5671461017d578063395093511461019b57806340c10f19146101cb576100ea565b806306fdde03146100ef578063095ea7b31461010d57806318160ddd1461013d575b600080fd5b6100f76102dd565b6040516101049190610726565b60405180910390f35b61012760048036038101906101229190610807565b61031a565b6040516101349190610862565b60405180910390f35b61014561033d565b604051610152919061088c565b60405180910390f35b610167600480360381019061016291906108a7565b610343565b6040516101749190610862565b60405180910390f35b610185610372565b6040516101929190610916565b60405180910390f35b6101b560048036038101906101b09190610807565b61037b565b6040516101c29190610862565b60405180910390f35b6101d56103b2565b005b6101ef60048036038101906101ea9190610931565b6103b5565b005b61020b6004803603810190610206919061095e565b6103ef565b604051610218919061088c565b60405180910390f35b61022b610407565b005b610245610407565b005b61024b61040a565b6040516102589190610726565b60405180910390f35b61027b60048036038101906102769190610931565b610447565b005b61029760048036038101906102929190610807565b61045e565b6040516102a49190610862565b60405180910390f35b6102c760048036038101906102c2919061098b565b610481565b6040516102d4919061088c565b60405180910390f35b60606040518060400160405280601081526020017f55534420436f696e20284d6f636b2900000000000000000000000000000000008152509050919050565b600081600360003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055508273ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925846040516103f1919061088c565b60405180910390a36001905092915050565b60015481565b60008061034f84610481565b905060008111801561036057508083105b156103695760019150505b5b50509392505050565b60006006905090565b6000610386336103ef565b90508181116103ca576103998282610506565b8373ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925856040516103f5919061088c565b60405180910390a360019150506103ac565b600091505b5b5092915050565b50565b60006103c082610569565b905060008111156103d4576103d5828261050b565b5b8173ffffffffffffffffffffffffffffffffffffffff16600073ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef83604051610434919061088c565b60405180910390a35050565b60606040518060400160405280600481526020017f5553444300000000000000000000000000000000000000000000000000000000815250905090565b610458610454335b90565b610569565b50505050565b600061046a3384610506565b61047483836105cd565b6001905092915050565b6000600360008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054905092915050565b6000600260008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050919050565b80600260008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000828254610558919061099a565b925050819055505050565b80600160008282546105759190610a04565b925050819055506105868282610506565b5050565b80600260008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008282546105d99190610a04565b925050819055505050565b8060026000600073ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082825461063491906109c8565b925050819055505050565b600081519050919050565b600082825260208201905092915050565b60005b8381101561067957808201518184015260208101905061065e565b60008484015250505050565b6000601f19601f8301169050919050565b60006106a18261063f565b6106ab818561064a565b93506106bb81856020860161065b565b6106c481610685565b840191505092915050565b6000819050919050565b6106e2816106cf565b82525050565b60006020820190508181036000830152610702818461069b565b905092915050565b600080fd5b600080fd5b610720816106cf565b811461072b57600080fd5b50565b60008135905061073d81610717565b92915050565b6000806040838503121561075a5761075961070d565b5b60006107688582860161072e565b925050602061077985828601610731565b9150509250929050565b60008115159050919050565b61079881610783565b82525050565b60006020820190506107b3600083018461078f565b92915050565b60006107c4826106cf565b91506107cf836106cf565b92508282039050818111156107e7576107e6610a38565b5b92915050565b6107f681610783565b811461080157600080fd5b50565b600081359050610813816107ed565b92915050565b6000806000606084860312156108325761083161070d565b5b600061084086828701610804565b935050602061085186828701610804565b925050604061086286828701610731565b9150509250925092565b6000610877826106cf565b9150610882836106cf565b9250828201905080821115610899576108996109f7565b5b92915050565b6108a881610783565b82525050565b60006020820190506108c3600083018461089f565b92915050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b60006108f4826108c9565b9050919050565b610904816108e9565b811461090f57600080fd5b50565b600081359050610921816108fb565b92915050565b60006020828403121561093d5761093c61070d565b5b600061094b84828501610912565b91505092915050565b6000806040838503121561096b5761096a61070d565b5b600061097985828601610912565b925050602061098a85828601610912565b9150509250929050565b60006109a0826106cf565b91506109ab836106cf565b92508282101580156109be57506109be610a38565b5b92915050565b60006109cf826106cf565b91506109da836106cf565b9250828201905080821015610991576109f1610a38565b5b92915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b610a2f816106cf565b82525050565b6000602082019050610a4a6000830184610a26565b9291505056fea2646970667358221220f8c3d7e87a582f45d20d12f3b8e73f6df8a9c5e2a1b3d4f6e0c5a7b9c8d1e2f3a64736f6c63430008140033';

async function main() {
  const privateKey = process.env.DEPLOYER_PRIVATE_KEY as `0x${string}`;
  const account = privateKeyToAccount(privateKey);

  console.log('üöÄ Deploying and Testing MockUSDC on Arc Testnet');
  console.log('üìç Deployer Address:', account.address);

  const walletClient = createWalletClient({
    account,
    chain: arcTestnet,
    transport: http('https://rpc.testnet.arc.network'),
  });

  const publicClient = createPublicClient({
    chain: arcTestnet,
    transport: http('https://rpc.testnet.arc.network'),
  });

  console.log('\nüìù Step 1: Deploying MockUSDC contract...');
  const deployHash = await walletClient.deployContract({
    abi: [],
    bytecode: MOCKUSDC_BYTECODE,
  });

  console.log('‚è≥ Waiting for deployment transaction...');
  console.log('üîó Deployment TX:', `https://testnet.arcscan.net/tx/${deployHash}`);

  const receipt = await publicClient.waitForTransactionReceipt({ hash: deployHash });
  const mockUSDCAddress = receipt.contractAddress;

  if (!mockUSDCAddress) {
    throw new Error('Failed to get contract address');
  }

  console.log('‚úÖ MockUSDC deployed at:', mockUSDCAddress);
  console.log('üîó Contract:', `https://testnet.arcscan.net/address/${mockUSDCAddress}`);

  console.log('\nüí∞ Step 2: Minting 10,000 USDC to treasury wallet...');
  const treasuryAddress = process.env.VITE_TREASURY_WALLET_ADDRESS as `0x${string}`;

  const mintHash = await walletClient.writeContract({
    address: mockUSDCAddress,
    abi: [
      {
        inputs: [
          { internalType: 'address', name: 'to', type: 'address' },
          { internalType: 'uint256', name: 'amount', type: 'uint256' },
        ],
        name: 'mint',
        outputs: [{ internalType: 'bool', name: '', type: 'bool' }],
        stateMutability: 'nonpayable',
        type: 'function',
      },
    ],
    functionName: 'mint',
    args: [treasuryAddress, parseUnits('10000', 6)],
  });

  await publicClient.waitForTransactionReceipt({ hash: mintHash });
  console.log('‚úÖ Minted 10,000 USDC to treasury');
  console.log('üîó Mint TX:', `https://testnet.arcscan.net/tx/${mintHash}`);

  console.log('\nüí∏ Step 3: Sending 100 USDC to test wallet...');
  const testWallet = '0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb'; // Replace with your wallet

  const transferHash = await walletClient.writeContract({
    address: mockUSDCAddress,
    abi: [
      {
        inputs: [
          { internalType: 'address', name: 'to', type: 'address' },
          { internalType: 'uint256', name: 'amount', type: 'uint256' },
        ],
        name: 'transfer',
        outputs: [{ internalType: 'bool', name: '', type: 'bool' }],
        stateMutability: 'nonpayable',
        type: 'function',
      },
    ],
    functionName: 'transfer',
    args: [testWallet as `0x${string}`, parseUnits('100', 6)],
  });

  await publicClient.waitForTransactionReceipt({ hash: transferHash });
  console.log('‚úÖ Sent 100 USDC to test wallet');
  console.log('üîó Transfer TX:', `https://testnet.arcscan.net/tx/${transferHash}`);

  console.log('\nüìä Step 4: Checking balances...');
  const balanceAbi = [
    {
      inputs: [{ internalType: 'address', name: 'account', type: 'address' }],
      name: 'balanceOf',
      outputs: [{ internalType: 'uint256', name: '', type: 'uint256' }],
      stateMutability: 'view',
      type: 'function',
    },
  ];

  const treasuryBalance = await publicClient.readContract({
    address: mockUSDCAddress,
    abi: balanceAbi,
    functionName: 'balanceOf',
    args: [treasuryAddress],
  });

  const testWalletBalance = await publicClient.readContract({
    address: mockUSDCAddress,
    abi: balanceAbi,
    functionName: 'balanceOf',
    args: [testWallet as `0x${string}`],
  });

  console.log('üí∞ Treasury Balance:', formatUnits(treasuryBalance as bigint, 6), 'USDC');
  console.log('üí∞ Test Wallet Balance:', formatUnits(testWalletBalance as bigint, 6), 'USDC');

  console.log('\n‚úÖ COMPLETE! Update your .env file:');
  console.log(`VITE_MOCK_USDC_ADDRESS=${mockUSDCAddress}`);
  console.log(`VITE_USDC_ADDRESS=${mockUSDCAddress}`);
  console.log('\nüåê View all transactions on Arc Explorer:');
  console.log(`https://testnet.arcscan.net/address/${mockUSDCAddress}`);
}

main().catch(console.error);
