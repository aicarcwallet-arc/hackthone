<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Treasury Auto-Recharge - AI Cognitive Token</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-gray-900 via-gray-800 to-black min-h-screen p-4 sm:p-8">
  <div class="max-w-5xl mx-auto">
    <div class="bg-gray-800 rounded-2xl shadow-2xl p-6 sm:p-8 border border-cyan-500/30">
      <div class="flex items-center gap-3 mb-6">
        <div class="w-12 h-12 bg-gradient-to-r from-green-500 to-emerald-600 rounded-full flex items-center justify-center">
          <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
        </div>
        <div>
          <h1 class="text-2xl font-bold text-white">Treasury Auto-Recharge Tester</h1>
          <p class="text-sm text-cyan-400">Monitor and test automatic treasury funding</p>
        </div>
      </div>

      <div class="bg-blue-900/30 border-l-4 border-blue-500 p-4 mb-6">
        <div class="flex">
          <div class="flex-shrink-0">
            <svg class="h-5 w-5 text-blue-400" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
            </svg>
          </div>
          <div class="ml-3">
            <p class="text-sm text-blue-300">
              This tool monitors treasury balance and tests the auto-recharge mechanism. When treasury drops below 1000 USDC, it automatically refills to 5000 USDC.
            </p>
          </div>
        </div>
      </div>

      <div id="status" class="mb-6 hidden"></div>

      <!-- Step 1: Connect & Configure -->
      <div class="mb-8">
        <h2 class="text-lg font-bold text-cyan-400 mb-4">Step 1: Connect & Configure</h2>
        <div class="space-y-4">
          <button
            id="connectBtn"
            class="w-full bg-gradient-to-r from-cyan-500 to-blue-600 hover:from-cyan-400 hover:to-blue-500 text-white font-semibold py-4 rounded-lg transition-all shadow-lg"
          >
            Connect MetaMask
          </button>

          <div id="configInputs" class="hidden space-y-3">
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">TreasuryAutoRecharge Contract</label>
              <input
                type="text"
                id="autoRechargeAddress"
                placeholder="0x..."
                class="w-full px-4 py-3 bg-gray-700 text-white border border-cyan-500/30 rounded-lg focus:ring-2 focus:ring-cyan-500"
              />
            </div>

            <button
              id="loadContractBtn"
              class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg transition-colors"
            >
              Load Contract
            </button>
          </div>
        </div>
      </div>

      <!-- Step 2: Treasury Status -->
      <div class="mb-8 hidden" id="statusSection">
        <h2 class="text-lg font-bold text-cyan-400 mb-4">Step 2: Treasury Status</h2>

        <div class="grid md:grid-cols-3 gap-4 mb-6">
          <div class="bg-gradient-to-br from-blue-900/50 to-cyan-900/50 rounded-xl p-6 border border-cyan-500/30">
            <p class="text-gray-300 text-sm mb-2">Treasury Balance</p>
            <p id="treasuryBalanceDisplay" class="text-3xl font-bold text-white">--</p>
            <p class="text-xs text-gray-400 mt-1">USDC available</p>
          </div>

          <div class="bg-gradient-to-br from-green-900/50 to-emerald-900/50 rounded-xl p-6 border border-green-500/30">
            <p class="text-gray-300 text-sm mb-2">Auto-Recharge Balance</p>
            <p id="contractBalanceDisplay" class="text-3xl font-bold text-white">--</p>
            <p class="text-xs text-gray-400 mt-1">USDC in reserve</p>
          </div>

          <div class="bg-gradient-to-br from-purple-900/50 to-pink-900/50 rounded-xl p-6 border border-pink-500/30">
            <p class="text-gray-300 text-sm mb-2">Needs Recharge?</p>
            <p id="needsRechargeDisplay" class="text-3xl font-bold text-white">--</p>
            <p class="text-xs text-gray-400 mt-1">Status check</p>
          </div>
        </div>

        <div class="flex gap-4">
          <button
            id="refreshStatusBtn"
            class="flex-1 bg-gray-700 hover:bg-gray-600 text-white font-semibold py-3 rounded-lg transition-colors"
          >
            Refresh Status
          </button>
          <button
            id="enableAutoRefreshBtn"
            class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg transition-colors"
          >
            Enable Auto-Refresh (10s)
          </button>
        </div>
      </div>

      <!-- Step 3: Test Recharge -->
      <div class="mb-8 hidden" id="rechargeSection">
        <h2 class="text-lg font-bold text-cyan-400 mb-4">Step 3: Test Auto-Recharge</h2>

        <div class="bg-gray-700/30 rounded-lg p-6 border border-cyan-500/20 mb-4">
          <h3 class="font-semibold text-white mb-3">Recharge Configuration</h3>
          <div class="space-y-2 text-sm">
            <div class="flex justify-between">
              <span class="text-gray-400">Minimum Threshold:</span>
              <span id="minThreshold" class="text-cyan-400 font-bold">1,000 USDC</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-400">Recharge Amount:</span>
              <span id="rechargeAmount" class="text-green-400 font-bold">5,000 USDC</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-400">Treasury Address:</span>
              <span class="font-mono text-xs text-cyan-400">0x4390...BF05</span>
            </div>
          </div>
        </div>

        <button
          id="triggerRechargeBtn"
          class="w-full bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-400 hover:to-emerald-500 text-white font-bold py-4 rounded-lg transition-all shadow-lg"
        >
          Trigger Auto-Recharge Now
        </button>

        <p class="text-xs text-gray-400 mt-3 text-center">
          This will check treasury balance and recharge if below threshold
        </p>
      </div>

      <!-- Transaction History -->
      <div class="hidden" id="historySection">
        <h2 class="text-lg font-bold text-cyan-400 mb-4">Recent Recharge Events</h2>
        <div id="eventsList" class="space-y-3">
          <p class="text-sm text-gray-400 text-center py-8">No recharge events yet</p>
        </div>
      </div>

      <!-- Help Section -->
      <div class="mt-8 p-4 bg-gray-700/30 rounded-lg border border-cyan-500/20">
        <h3 class="font-semibold text-white mb-3">How It Works</h3>
        <div class="space-y-2 text-sm text-gray-300">
          <p>1. Treasury balance monitored continuously</p>
          <p>2. When balance drops below 1,000 USDC â†’ auto-recharge triggers</p>
          <p>3. Contract sends 5,000 USDC from reserve to treasury</p>
          <p>4. Treasury restocked and ready for player rewards</p>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    const ARC_TESTNET = {
      chainId: '0x7AF',
      chainName: 'Arc Testnet',
      nativeCurrency: { name: 'ARC', symbol: 'ARC', decimals: 18 },
      rpcUrls: ['https://rpc-testnet.arcscan.net'],
      blockExplorerUrls: ['https://testnet.arcscan.net']
    };

    const AUTO_RECHARGE_ABI = [
      {
        inputs: [],
        name: 'getTreasuryStatus',
        outputs: [
          { internalType: 'bool', name: 'needsRecharge', type: 'bool' },
          { internalType: 'uint256', name: 'treasuryBalance', type: 'uint256' },
          { internalType: 'uint256', name: 'contractBalance', type: 'uint256' }
        ],
        stateMutability: 'view',
        type: 'function'
      },
      {
        inputs: [],
        name: 'checkAndRecharge',
        outputs: [{ internalType: 'bool', name: 'recharged', type: 'bool' }],
        stateMutability: 'nonpayable',
        type: 'function'
      },
      {
        inputs: [],
        name: 'minimumBalance',
        outputs: [{ internalType: 'uint256', name: '', type: 'uint256' }],
        stateMutability: 'view',
        type: 'function'
      },
      {
        inputs: [],
        name: 'rechargeAmount',
        outputs: [{ internalType: 'uint256', name: '', type: 'uint256' }],
        stateMutability: 'view',
        type: 'function'
      }
    ];

    let account, contract, autoRefreshInterval;

    function showStatus(message, type = 'info') {
      const status = document.getElementById('status');
      status.className = `mb-6 p-4 rounded-lg ${
        type === 'error' ? 'bg-red-900/30 text-red-300 border border-red-500/30' :
        type === 'success' ? 'bg-green-900/30 text-green-300 border border-green-500/30' :
        'bg-blue-900/30 text-blue-300 border border-blue-500/30'
      }`;
      status.textContent = message;
      status.classList.remove('hidden');
    }

    function formatUSDC(value) {
      return (Number(ethers.utils.formatUnits(value, 6))).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    document.getElementById('connectBtn').onclick = async () => {
      try {
        if (!window.ethereum) {
          showStatus('MetaMask not found!', 'error');
          return;
        }

        const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
        account = accounts[0];

        try {
          await ethereum.request({
            method: 'wallet_switchEthereumChain',
            params: [{ chainId: ARC_TESTNET.chainId }],
          });
        } catch (switchError) {
          if (switchError.code === 4902) {
            await ethereum.request({
              method: 'wallet_addEthereumChain',
              params: [ARC_TESTNET],
            });
          } else throw switchError;
        }

        document.getElementById('connectBtn').classList.add('hidden');
        document.getElementById('configInputs').classList.remove('hidden');
        showStatus('Connected successfully!', 'success');

      } catch (error) {
        showStatus(`Connection error: ${error.message}`, 'error');
      }
    };

    document.getElementById('loadContractBtn').onclick = async () => {
      try {
        const address = document.getElementById('autoRechargeAddress').value.trim();
        if (!address || !address.startsWith('0x')) {
          showStatus('Please enter a valid contract address', 'error');
          return;
        }

        const provider = new ethers.providers.Web3Provider(window.ethereum);
        contract = new ethers.Contract(address, AUTO_RECHARGE_ABI, provider.getSigner());

        await refreshStatus();

        document.getElementById('statusSection').classList.remove('hidden');
        document.getElementById('rechargeSection').classList.remove('hidden');
        document.getElementById('historySection').classList.remove('hidden');

        showStatus('Contract loaded successfully!', 'success');

      } catch (error) {
        showStatus(`Error loading contract: ${error.message}`, 'error');
      }
    };

    async function refreshStatus() {
      try {
        const status = await contract.getTreasuryStatus();
        const minBalance = await contract.minimumBalance();
        const rechargeAmt = await contract.rechargeAmount();

        document.getElementById('treasuryBalanceDisplay').textContent = formatUSDC(status.treasuryBalance);
        document.getElementById('contractBalanceDisplay').textContent = formatUSDC(status.contractBalance);
        document.getElementById('needsRechargeDisplay').textContent = status.needsRecharge ? 'YES' : 'NO';
        document.getElementById('needsRechargeDisplay').className = `text-3xl font-bold ${status.needsRecharge ? 'text-yellow-400' : 'text-green-400'}`;

        document.getElementById('minThreshold').textContent = formatUSDC(minBalance) + ' USDC';
        document.getElementById('rechargeAmount').textContent = formatUSDC(rechargeAmt) + ' USDC';

      } catch (error) {
        showStatus(`Error refreshing status: ${error.message}`, 'error');
      }
    }

    document.getElementById('refreshStatusBtn').onclick = refreshStatus;

    document.getElementById('enableAutoRefreshBtn').onclick = () => {
      if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
        document.getElementById('enableAutoRefreshBtn').textContent = 'Enable Auto-Refresh (10s)';
        showStatus('Auto-refresh disabled', 'info');
      } else {
        autoRefreshInterval = setInterval(refreshStatus, 10000);
        document.getElementById('enableAutoRefreshBtn').textContent = 'Disable Auto-Refresh';
        showStatus('Auto-refresh enabled (every 10 seconds)', 'success');
      }
    };

    document.getElementById('triggerRechargeBtn').onclick = async () => {
      try {
        showStatus('Checking treasury and triggering recharge... Confirm in MetaMask', 'info');

        const tx = await contract.checkAndRecharge();
        showStatus(`Transaction sent! Hash: ${tx.hash.slice(0, 10)}...`, 'info');

        const receipt = await tx.wait();

        if (receipt.status === 1) {
          showStatus('Recharge completed successfully!', 'success');
          await refreshStatus();

          const eventDiv = document.createElement('div');
          eventDiv.className = 'bg-green-900/20 border border-green-500/30 rounded-lg p-4';
          eventDiv.innerHTML = `
            <p class="text-sm text-green-300 font-semibold">Recharge Event</p>
            <p class="text-xs text-gray-400 mt-1">${new Date().toLocaleString()}</p>
            <p class="text-xs text-gray-400 font-mono mt-1">${tx.hash.slice(0, 20)}...</p>
          `;
          document.getElementById('eventsList').prepend(eventDiv);
        }

      } catch (error) {
        showStatus(`Recharge error: ${error.message}`, 'error');
      }
    };
  </script>
  <script src="https://cdn.ethers.io/lib/ethers-5.7.umd.min.js"></script>
</body>
</html>
